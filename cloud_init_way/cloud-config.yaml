#cloud-config

package_update: true
package_upgrade: true

groups:
  - docker
  - ssl-cert
  - libvirt
  - kvm

users:
  - default
  - name: xrdp 
    primary_group: ssl-cert
  - name: user
    plain_text_passwd: 'ubuntumsi12'
    groups: ssl-cert, libvirt, kvm, docker
    lock_passwd: False
    sudo: False
    shell: /bin/bash

 
# INSTALING DOCKER
apt:
  sources:
    docker.list:
      source: deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable
      keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
  
packages:
  - xorg
  - xinit
  - i3
  - xrdp
  - midori
  - debconf-utils
  - apt-transport-https 
  - ca-certificates 
  - curl 
  - gnupg-agent
  - software-properties-common
  - docker-ce
  - docker-ce-cli
  - containerd.io

# Enable ipv4 forwarding, required on CIS hardened machines
write_files:
  - path: /etc/sysctl.d/enabled_ipv4_forwarding.conf
    content: |
      net.ipv4.conf.all.forwarding=1
  - encoding: b64
    content: IyBpMyBjb25maWcgZmlsZSAodjQpCiMKIyBQbGVhc2Ugc2VlIGh0dHBzOi8vaTN3bS5vcmcvZG9jcy91c2VyZ3VpZGUuaHRtbCBmb3IgYSBjb21wbGV0ZSByZWZlcmVuY2UhCiMKIyBUaGlzIGNvbmZpZyBmaWxlIHVzZXMga2V5Y29kZXMgKGJpbmRzeW0pIGFuZCB3YXMgd3JpdHRlbiBmb3IgdGhlIFFXRVJUWQojIGxheW91dC4KIwojIFRvIGdldCBhIGNvbmZpZyBmaWxlIHdpdGggdGhlIHNhbWUga2V5IHBvc2l0aW9ucywgYnV0IGZvciB5b3VyIGN1cnJlbnQKIyBsYXlvdXQsIHVzZSB0aGUgaTMtY29uZmlnLXdpemFyZAojCgojIEZvbnQgZm9yIHdpbmRvdyB0aXRsZXMuIFdpbGwgYWxzbyBiZSB1c2VkIGJ5IHRoZSBiYXIgdW5sZXNzIGEgZGlmZmVyZW50IGZvbnQKIyBpcyB1c2VkIGluIHRoZSBiYXIge30gYmxvY2sgYmVsb3cuCmZvbnQgcGFuZ286bW9ub3NwYWNlIDgKCiMgVGhpcyBmb250IGlzIHdpZGVseSBpbnN0YWxsZWQsIHByb3ZpZGVzIGxvdHMgb2YgdW5pY29kZSBnbHlwaHMsIHJpZ2h0LXRvLWxlZnQKIyB0ZXh0IHJlbmRlcmluZyBhbmQgc2NhbGFiaWxpdHkgb24gcmV0aW5hL2hpZHBpIGRpc3BsYXlzICh0aGFua3MgdG8gcGFuZ28pLgojZm9udCBwYW5nbzpEZWphVnUgU2FucyBNb25vIDgKCiMgVGhlIGNvbWJpbmF0aW9uIG9mIHhzcy1sb2NrLCBubS1hcHBsZXQgYW5kIHBhY3RsIGlzIGEgcG9wdWxhciBjaG9pY2UsIHNvCiMgdGhleSBhcmUgaW5jbHVkZWQgaGVyZSBhcyBhbiBleGFtcGxlLiBNb2RpZnkgYXMgeW91IHNlZSBmaXQuCgojIHhzcy1sb2NrIGdyYWJzIGEgbG9naW5kIHN1c3BlbmQgaW5oaWJpdCBsb2NrIGFuZCB3aWxsIHVzZSBpM2xvY2sgdG8gbG9jayB0aGUKIyBzY3JlZW4gYmVmb3JlIHN1c3BlbmQuIFVzZSBsb2dpbmN0bCBsb2NrLXNlc3Npb24gdG8gbG9jayB5b3VyIHNjcmVlbi4KZXhlYyAtLW5vLXN0YXJ0dXAtaWQgeHNzLWxvY2sgLS10cmFuc2Zlci1zbGVlcC1sb2NrIC0tIGkzbG9jayAtLW5vZm9yawoKIyBOZXR3b3JrTWFuYWdlciBpcyB0aGUgbW9zdCBwb3B1bGFyIHdheSB0byBtYW5hZ2Ugd2lyZWxlc3MgbmV0d29ya3Mgb24gTGludXgsCiMgYW5kIG5tLWFwcGxldCBpcyBhIGRlc2t0b3AgZW52aXJvbm1lbnQtaW5kZXBlbmRlbnQgc3lzdGVtIHRyYXkgR1VJIGZvciBpdC4KZXhlYyAtLW5vLXN0YXJ0dXAtaWQgbm0tYXBwbGV0CgojIFVzZSBwYWN0bCB0byBhZGp1c3Qgdm9sdW1lIGluIFB1bHNlQXVkaW8uCnNldCAkcmVmcmVzaF9pM3N0YXR1cyBraWxsYWxsIC1TSUdVU1IxIGkzc3RhdHVzCmJpbmRzeW0gWEY4NkF1ZGlvUmFpc2VWb2x1bWUgZXhlYyAtLW5vLXN0YXJ0dXAtaWQgcGFjdGwgc2V0LXNpbmstdm9sdW1lIEBERUZBVUxUX1NJTktAICsxMCUgJiYgJHJlZnJlc2hfaTNzdGF0dXMKYmluZHN5bSBYRjg2QXVkaW9Mb3dlclZvbHVtZSBleGVjIC0tbm8tc3RhcnR1cC1pZCBwYWN0bCBzZXQtc2luay12b2x1bWUgQERFRkFVTFRfU0lOS0AgLTEwJSAmJiAkcmVmcmVzaF9pM3N0YXR1cwpiaW5kc3ltIFhGODZBdWRpb011dGUgZXhlYyAtLW5vLXN0YXJ0dXAtaWQgcGFjdGwgc2V0LXNpbmstbXV0ZSBAREVGQVVMVF9TSU5LQCB0b2dnbGUgJiYgJHJlZnJlc2hfaTNzdGF0dXMKYmluZHN5bSBYRjg2QXVkaW9NaWNNdXRlIGV4ZWMgLS1uby1zdGFydHVwLWlkIHBhY3RsIHNldC1zb3VyY2UtbXV0ZSBAREVGQVVMVF9TT1VSQ0VAIHRvZ2dsZSAmJiAkcmVmcmVzaF9pM3N0YXR1cwoKIyB1c2UgdGhlc2Uga2V5cyBmb3IgZm9jdXMsIG1vdmVtZW50LCBhbmQgcmVzaXplIGRpcmVjdGlvbnMgd2hlbiByZWFjaGluZyBmb3IKIyB0aGUgYXJyb3dzIGlzIG5vdCBjb252ZW5pZW50CiMgc2V0IGwgbAojIHNldCBrIGsKIyBzZXQgaiBqCiMgc2V0IHNlbWljb2xvbiBzZW1pY29sb24KCiMgdXNlIE1vdXNlK01vZDEgdG8gZHJhZyBmbG9hdGluZyB3aW5kb3dzIHRvIHRoZWlyIHdhbnRlZCBwb3NpdGlvbgpmbG9hdGluZ19tb2RpZmllciBNb2QxCgojIHN0YXJ0IGEgdGVybWluYWwKYmluZHN5bSBNb2QxK1JldHVybiBleGVjIGkzLXNlbnNpYmxlLXRlcm1pbmFsCgojIGtpbGwgZm9jdXNlZCB3aW5kb3cKYmluZHN5bSBNb2QxK1NoaWZ0K3Ega2lsbAoKIyBzdGFydCBkbWVudSAoYSBwcm9ncmFtIGxhdW5jaGVyKQpiaW5kc3ltIE1vZDErZCBleGVjIGRtZW51X3J1bgojIFRoZXJlIGFsc28gaXMgdGhlIChuZXcpIGkzLWRtZW51LWRlc2t0b3Agd2hpY2ggb25seSBkaXNwbGF5cyBhcHBsaWNhdGlvbnMKIyBzaGlwcGluZyBhIC5kZXNrdG9wIGZpbGUuIEl0IGlzIGEgd3JhcHBlciBhcm91bmQgZG1lbnUsIHNvIHlvdSBuZWVkIHRoYXQKIyBpbnN0YWxsZWQuCiMgYmluZHN5bSBNb2QxK2QgZXhlYyAtLW5vLXN0YXJ0dXAtaWQgaTMtZG1lbnUtZGVza3RvcAoKIyBjaGFuZ2UgZm9jdXMKYmluZHN5bSBNb2QxK2ogZm9jdXMgbGVmdApiaW5kc3ltIE1vZDErayBmb2N1cyBkb3duCmJpbmRzeW0gTW9kMStsIGZvY3VzIHVwCmJpbmRzeW0gTW9kMStzZW1pY29sb24gZm9jdXMgcmlnaHQKCiMgYWx0ZXJuYXRpdmVseSwgeW91IGNhbiB1c2UgdGhlIGN1cnNvciBrZXlzOgpiaW5kc3ltIE1vZDErTGVmdCBmb2N1cyBsZWZ0CmJpbmRzeW0gTW9kMStEb3duIGZvY3VzIGRvd24KYmluZHN5bSBNb2QxK1VwIGZvY3VzIHVwCmJpbmRzeW0gTW9kMStSaWdodCBmb2N1cyByaWdodAoKIyBtb3ZlIGZvY3VzZWQgd2luZG93CmJpbmRzeW0gTW9kMStTaGlmdCtqIG1vdmUgbGVmdApiaW5kc3ltIE1vZDErU2hpZnQrayBtb3ZlIGRvd24KYmluZHN5bSBNb2QxK1NoaWZ0K2wgbW92ZSB1cApiaW5kc3ltIE1vZDErU2hpZnQrc2VtaWNvbG9uIG1vdmUgcmlnaHQKCiMgYWx0ZXJuYXRpdmVseSwgeW91IGNhbiB1c2UgdGhlIGN1cnNvciBrZXlzOgpiaW5kc3ltIE1vZDErU2hpZnQrTGVmdCBtb3ZlIGxlZnQKYmluZHN5bSBNb2QxK1NoaWZ0K0Rvd24gbW92ZSBkb3duCmJpbmRzeW0gTW9kMStTaGlmdCtVcCBtb3ZlIHVwCmJpbmRzeW0gTW9kMStTaGlmdCtSaWdodCBtb3ZlIHJpZ2h0CgojIHNwbGl0IGluIGhvcml6b250YWwgb3JpZW50YXRpb24KYmluZHN5bSBNb2QxK2ggc3BsaXQgaAoKIyBzcGxpdCBpbiB2ZXJ0aWNhbCBvcmllbnRhdGlvbgpiaW5kc3ltIE1vZDErdiBzcGxpdCB2CgojIGVudGVyIGZ1bGxzY3JlZW4gbW9kZSBmb3IgdGhlIGZvY3VzZWQgY29udGFpbmVyCmJpbmRzeW0gTW9kMStmIGZ1bGxzY3JlZW4gdG9nZ2xlCgojIGNoYW5nZSBjb250YWluZXIgbGF5b3V0IChzdGFja2VkLCB0YWJiZWQsIHRvZ2dsZSBzcGxpdCkKYmluZHN5bSBNb2QxK3MgbGF5b3V0IHN0YWNraW5nCmJpbmRzeW0gTW9kMSt3IGxheW91dCB0YWJiZWQKYmluZHN5bSBNb2QxK2UgbGF5b3V0IHRvZ2dsZSBzcGxpdAoKIyB0b2dnbGUgdGlsaW5nIC8gZmxvYXRpbmcKYmluZHN5bSBNb2QxK1NoaWZ0K3NwYWNlIGZsb2F0aW5nIHRvZ2dsZQoKIyBjaGFuZ2UgZm9jdXMgYmV0d2VlbiB0aWxpbmcgLyBmbG9hdGluZyB3aW5kb3dzCmJpbmRzeW0gTW9kMStzcGFjZSBmb2N1cyBtb2RlX3RvZ2dsZQoKIyBmb2N1cyB0aGUgcGFyZW50IGNvbnRhaW5lcgpiaW5kc3ltIE1vZDErYSBmb2N1cyBwYXJlbnQKCiMgZm9jdXMgdGhlIGNoaWxkIGNvbnRhaW5lcgojYmluZHN5bSBNb2QxK2QgZm9jdXMgY2hpbGQKCiMgbW92ZSB0aGUgY3VycmVudGx5IGZvY3VzZWQgd2luZG93IHRvIHRoZSBzY3JhdGNocGFkCmJpbmRzeW0gTW9kMStTaGlmdCttaW51cyBtb3ZlIHNjcmF0Y2hwYWQKCiMgU2hvdyB0aGUgbmV4dCBzY3JhdGNocGFkIHdpbmRvdyBvciBoaWRlIHRoZSBmb2N1c2VkIHNjcmF0Y2hwYWQgd2luZG93LgojIElmIHRoZXJlIGFyZSBtdWx0aXBsZSBzY3JhdGNocGFkIHdpbmRvd3MsIHRoaXMgY29tbWFuZCBjeWNsZXMgdGhyb3VnaCB0aGVtLgpiaW5kc3ltIE1vZDErbWludXMgc2NyYXRjaHBhZCBzaG93CgojIERlZmluZSBuYW1lcyBmb3IgZGVmYXVsdCB3b3Jrc3BhY2VzIGZvciB3aGljaCB3ZSBjb25maWd1cmUga2V5IGJpbmRpbmdzIGxhdGVyIG9uLgojIFdlIHVzZSB2YXJpYWJsZXMgdG8gYXZvaWQgcmVwZWF0aW5nIHRoZSBuYW1lcyBpbiBtdWx0aXBsZSBwbGFjZXMuCnNldCAkd3MxICIxIgpzZXQgJHdzMiAiMiIKc2V0ICR3czMgIjMiCnNldCAkd3M0ICI0IgpzZXQgJHdzNSAiNSIKc2V0ICR3czYgIjYiCnNldCAkd3M3ICI3IgpzZXQgJHdzOCAiOCIKc2V0ICR3czkgIjkiCnNldCAkd3MxMCAiMTAiCgojIHN3aXRjaCB0byB3b3Jrc3BhY2UKYmluZHN5bSBNb2QxKzEgd29ya3NwYWNlIG51bWJlciAkd3MxCmJpbmRzeW0gTW9kMSsyIHdvcmtzcGFjZSBudW1iZXIgJHdzMgpiaW5kc3ltIE1vZDErMyB3b3Jrc3BhY2UgbnVtYmVyICR3czMKYmluZHN5bSBNb2QxKzQgd29ya3NwYWNlIG51bWJlciAkd3M0CmJpbmRzeW0gTW9kMSs1IHdvcmtzcGFjZSBudW1iZXIgJHdzNQpiaW5kc3ltIE1vZDErNiB3b3Jrc3BhY2UgbnVtYmVyICR3czYKYmluZHN5bSBNb2QxKzcgd29ya3NwYWNlIG51bWJlciAkd3M3CmJpbmRzeW0gTW9kMSs4IHdvcmtzcGFjZSBudW1iZXIgJHdzOApiaW5kc3ltIE1vZDErOSB3b3Jrc3BhY2UgbnVtYmVyICR3czkKYmluZHN5bSBNb2QxKzAgd29ya3NwYWNlIG51bWJlciAkd3MxMAoKIyBtb3ZlIGZvY3VzZWQgY29udGFpbmVyIHRvIHdvcmtzcGFjZQpiaW5kc3ltIE1vZDErU2hpZnQrMSBtb3ZlIGNvbnRhaW5lciB0byB3b3Jrc3BhY2UgbnVtYmVyICR3czEKYmluZHN5bSBNb2QxK1NoaWZ0KzIgbW92ZSBjb250YWluZXIgdG8gd29ya3NwYWNlIG51bWJlciAkd3MyCmJpbmRzeW0gTW9kMStTaGlmdCszIG1vdmUgY29udGFpbmVyIHRvIHdvcmtzcGFjZSBudW1iZXIgJHdzMwpiaW5kc3ltIE1vZDErU2hpZnQrNCBtb3ZlIGNvbnRhaW5lciB0byB3b3Jrc3BhY2UgbnVtYmVyICR3czQKYmluZHN5bSBNb2QxK1NoaWZ0KzUgbW92ZSBjb250YWluZXIgdG8gd29ya3NwYWNlIG51bWJlciAkd3M1CmJpbmRzeW0gTW9kMStTaGlmdCs2IG1vdmUgY29udGFpbmVyIHRvIHdvcmtzcGFjZSBudW1iZXIgJHdzNgpiaW5kc3ltIE1vZDErU2hpZnQrNyBtb3ZlIGNvbnRhaW5lciB0byB3b3Jrc3BhY2UgbnVtYmVyICR3czcKYmluZHN5bSBNb2QxK1NoaWZ0KzggbW92ZSBjb250YWluZXIgdG8gd29ya3NwYWNlIG51bWJlciAkd3M4CmJpbmRzeW0gTW9kMStTaGlmdCs5IG1vdmUgY29udGFpbmVyIHRvIHdvcmtzcGFjZSBudW1iZXIgJHdzOQpiaW5kc3ltIE1vZDErU2hpZnQrMCBtb3ZlIGNvbnRhaW5lciB0byB3b3Jrc3BhY2UgbnVtYmVyICR3czEwCgojIGtleWJvYXJkIGxheW91dApzZXQgJG1zIE1vZDQKYmluZHN5bSAkbXMrcyBleGVjIHNldHhrYm1hcCBzaQpiaW5kc3ltICRtcyt1IGV4ZWMgc2V0eGtibWFwIHVzCmV4ZWMgInNldHhrYm1hcCAtbGF5b3V0IHNpIgoKIyByZWxvYWQgdGhlIGNvbmZpZ3VyYXRpb24gZmlsZQpiaW5kc3ltIE1vZDErU2hpZnQrYyByZWxvYWQKIyByZXN0YXJ0IGkzIGlucGxhY2UgKHByZXNlcnZlcyB5b3VyIGxheW91dC9zZXNzaW9uLCBjYW4gYmUgdXNlZCB0byB1cGdyYWRlIGkzKQpiaW5kc3ltIE1vZDErU2hpZnQrciByZXN0YXJ0CiMgZXhpdCBpMyAobG9ncyB5b3Ugb3V0IG9mIHlvdXIgWCBzZXNzaW9uKQpiaW5kc3ltIE1vZDErU2hpZnQrZSBleGVjICJpMy1uYWdiYXIgLXQgd2FybmluZyAtbSAnWW91IHByZXNzZWQgdGhlIGV4aXQgc2hvcnRjdXQuIERvIHlvdSByZWFsbHkgd2FudCB0byBleGl0IGkzPyBUaGlzIHdpbGwgZW5kIHlvdXIgWCBzZXNzaW9uLicgLUIgJ1llcywgZXhpdCBpMycgJ2kzLW1zZyBleGl0JyIKCiMgcmVzaXplIHdpbmRvdyAoeW91IGNhbiBhbHNvIHVzZSB0aGUgbW91c2UgZm9yIHRoYXQpCm1vZGUgInJlc2l6ZSIgewogICAgICAgICMgVGhlc2UgYmluZGluZ3MgdHJpZ2dlciBhcyBzb29uIGFzIHlvdSBlbnRlciB0aGUgcmVzaXplIG1vZGUKCiAgICAgICAgIyBQcmVzc2luZyBsZWZ0IHdpbGwgc2hyaW5rIHRoZSB3aW5kb3figJlzIHdpZHRoLgogICAgICAgICMgUHJlc3NpbmcgcmlnaHQgd2lsbCBncm93IHRoZSB3aW5kb3figJlzIHdpZHRoLgogICAgICAgICMgUHJlc3NpbmcgdXAgd2lsbCBzaHJpbmsgdGhlIHdpbmRvd+KAmXMgaGVpZ2h0LgogICAgICAgICMgUHJlc3NpbmcgZG93biB3aWxsIGdyb3cgdGhlIHdpbmRvd+KAmXMgaGVpZ2h0LgogICAgICAgIGJpbmRzeW0gaiAgICAgICByZXNpemUgc2hyaW5rIHdpZHRoIDEwIHB4IG9yIDEwIHBwdAogICAgICAgIGJpbmRzeW0gayAgICAgICByZXNpemUgZ3JvdyBoZWlnaHQgMTAgcHggb3IgMTAgcHB0CiAgICAgICAgYmluZHN5bSBsICAgICAgICAgcmVzaXplIHNocmluayBoZWlnaHQgMTAgcHggb3IgMTAgcHB0CiAgICAgICAgYmluZHN5bSBzZW1pY29sb24gICAgICByZXNpemUgZ3JvdyB3aWR0aCAxMCBweCBvciAxMCBwcHQKCiAgICAgICAgIyBzYW1lIGJpbmRpbmdzLCBidXQgZm9yIHRoZSBhcnJvdyBrZXlzCiAgICAgICAgYmluZHN5bSBMZWZ0ICAgICAgICByZXNpemUgc2hyaW5rIHdpZHRoIDEwIHB4IG9yIDEwIHBwdAogICAgICAgIGJpbmRzeW0gRG93biAgICAgICAgcmVzaXplIGdyb3cgaGVpZ2h0IDEwIHB4IG9yIDEwIHBwdAogICAgICAgIGJpbmRzeW0gVXAgICAgICAgICAgcmVzaXplIHNocmluayBoZWlnaHQgMTAgcHggb3IgMTAgcHB0CiAgICAgICAgYmluZHN5bSBSaWdodCAgICAgICByZXNpemUgZ3JvdyB3aWR0aCAxMCBweCBvciAxMCBwcHQKCiAgICAgICAgIyBiYWNrIHRvIG5vcm1hbDogRW50ZXIgb3IgRXNjYXBlIG9yIE1vZDErcgogICAgICAgIGJpbmRzeW0gUmV0dXJuIG1vZGUgImRlZmF1bHQiCiAgICAgICAgYmluZHN5bSBFc2NhcGUgbW9kZSAiZGVmYXVsdCIKICAgICAgICBiaW5kc3ltIE1vZDErciBtb2RlICJkZWZhdWx0Igp9CgpiaW5kc3ltIE1vZDErciBtb2RlICJyZXNpemUiCgojIFN0YXJ0IGkzYmFyIHRvIGRpc3BsYXkgYSB3b3Jrc3BhY2UgYmFyIChwbHVzIHRoZSBzeXN0ZW0gaW5mb3JtYXRpb24gaTNzdGF0dXMKIyBmaW5kcyBvdXQsIGlmIGF2YWlsYWJsZSkKYmFyIHsKICAgICAgICBzdGF0dXNfY29tbWFuZCBpM3N0YXR1cwp9Cg==
    owner: root:root
    path: /config
    permissions: '0644'
 
# Add default auto created user to docker group
system_info:
  default_user:
    groups: [docker]

runcmd:  
  - add-apt-repository "ppa:gns3/ppa" -y 
  - echo "wireshark-common wireshark-common/install-setuid boolean true" | debconf-set-selections
  - echo "ubridge ubridge/install-setuid boolean true" | debconf-set-selections
  - DEBIAN_FRONTEND=noninteractive apt-get install gns3-gui gns3-server -y 
  - usermod -aG ubridge,wireshark user
  - mkdir -p /home/user/.config/i3
  - mv /config /home/user/.config/i3/config
  - chown -R user /usr/bin/dumpcap
  - chown -R user /home/user
  - echo "exec i3" >> ~/.xinitrc
  - systemctl enable xrdp
  - ufw allow from any to any port 3389 proto tcp 
  - echo "KONEC"
  
power_state:
  mode: reboot 
  message: I'll be back...
